<% layout('layout') %>
<div class="top-bar px-3 py-2" style="background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 gap-md-4 flex-wrap w-100">
    <h4 class="mb-0 me-md-3">스코어 테이블</h4>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">주간 수행량</label>
      <input type="text" class="form-control form-control-sm text-end" id="weeklyTotalCount" readonly style="width: 60px;">
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">거절 및 배차취소</label>
      <input type="text" class="form-control form-control-sm text-end" id="weeklyCancelScore" readonly style="width: 60px;">
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">수행율 (%)</label>
      <input type="text" class="form-control form-control-sm text-end" id="weeklyAchievement" readonly style="width: 60px;">
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">수행율 점수</label>
      <input type="text" class="form-control form-control-sm text-end" id="weeklyAchievementScore" readonly style="width: 60px;">
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">시간대 총 점수</label>
      <input type="text" class="form-control form-control-sm text-end" id="weeklyTimeSlotScore" readonly style="width: 60px;">
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0" style="font-size: 1.2rem;">주간 합산 점수</label>
      <input type="text" class="form-control text-center" id="weeklyTotalScore"
             readonly style="width: 80px; background-color: #e5fa85; font-size: 1.4rem;">
    </div>

    <% if (adminList.some(admin => admin.username === currentUser?.username)) { %>
        <button id="calculateButton" class="btn btn-primary ms-md-4 mt-2 mt-md-0">저장 하기</button>
    <% } %>
  </div>
</div>

<div class="main-content">
  <div class="container-fluid">
    <div class="row row-cols-1 row-cols-md-2 g-4">
      <% const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];
         const labels = {
           'Wednesday':'수요일','Thursday':'목요일','Friday':'금요일','Saturday':'토요일',
           'Sunday':'일요일','Monday':'월요일','Tuesday':'화요일'
         };
         const goals = {
           'Wednesday':[21,20,30,29],
           'Thursday':[21,20,30,29],
           'Friday':[24,21,32,33],
           'Saturday':[31,22,36,31],
           'Sunday':[33,22,35,30],
           'Monday':[21,20,30,29],
           'Tuesday':[21,20,30,29],
         };
      %>
      <% for (let day of days) { %>
      <div class="col">
        <h4 class="text-center align-middle"><%= labels[day] %></h4>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th class="text-center align-middle" style="width: 30.5%; background-color: #ced0f4;">운행 요일</th>
                <th class="text-center align-middle" style="width: 30.5%; background-color: #ced0f4;">운행 시간대</th>
                <th class="text-center align-middle" style="width: 13%; background-color: #ced0f4;">목표<br>수행량</th>
                <th class="text-center align-middle" style="width: 13%; background-color: #ced0f4;">실제<br>수행량</th>
                <th class="text-center align-middle" style="width: 13%; background-color: #ced0f4;">달성<br>점수</th>
              </tr>
            </thead>
            <tbody>
              <% const times = ['오전/점심 피크','오후 논 피크','저녁 피크','심야 논 피크']; %>
              <% for (let i = 0; i < 4; i++) { %>
                <tr>
                  <% if (i === 0) { %>
                    <td class="text-center align-middle" rowspan="7"><%= labels[day] %></td>
                  <% } %>
                  <td class="text-center align-middle"><%= times[i] %></td>
                  <td class="text-center align-middle" style="background-color: #ffb9b9;"><input class="form-control" style="background-color: #ffb9b9;" name="<%= day %>tg<%= i+1 %>" value="<%= goals[day][i] %>" readonly></td>
                  <td class="text-center align-middle" style="background-color: #fffaa3;"><input class="form-control" name="<%= day %>Cnt<%= i+1 %>"></td>
                  <td class="text-center align-middle" style="background-color: #cec5ff;"><input class="form-control" style="background-color: #cec5ff;" name="<%= day %>Value<%= i+1 %>" readonly></td>
                </tr>
              <% } %>
              <tr>
                <td colspan="2" class="text-center align-middle">거절</td>
                <td colspan="2" style="background-color: #ffb8b8;"><input class="form-control" name="<%= day %>Denied"></td>
              </tr>
              <tr>
                <td colspan="2" class="text-center align-middle">배차 취소</td>
                <td colspan="2" style="background-color: hsl(206, 100%, 87%);"><input class="form-control" name="<%= day %>Cancel"></td>
              </tr>
              <tr>
                <td colspan="2" class="text-center align-middle">일 점수</td>
                <td colspan="2"><input class="form-control" style="background-color: #ffadf8;"name="<%= day %>Total"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<script>
  const currentUsername = "<%= currentUser?.username || '' %>";
  const adminUsernames = <%- JSON.stringify(adminList.map(a => a.username)) %>;
  const isAdmin = adminUsernames.includes(currentUsername);
  const savedData = <%- JSON.stringify(allScoreData) %>;  // 모든 유저의 점수 데이터
</script>


<script src="/js/score-calculation.js"></script> <!-- 위 JS 코드 분리 시 이 경로 사용 가능 -->

<script>
  const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];

  function calculateDailyScore(day) {
    let totalScore = 0;
    for (let i = 1; i <= 4; i++) {
      const goal = parseInt(document.querySelector(`[name="${day}tg${i}"]`).value);
      const actual = parseInt(document.querySelector(`[name="${day}Cnt${i}"]`).value);
      const scoreCell = document.querySelector(`[name="${day}Value${i}"]`);
      if (isNaN(actual)) {
        scoreCell.value = "0";
        continue;
      }
      let score = 0;
      if (actual >= goal) {
        if (day === 'Friday') score = [2,2,3,2][i-1];
        else if (day === 'Saturday') score = [3,2,3,2][i-1];
        else if (day === 'Sunday') score = [3,2,3,1][i-1];
        else score = [2,2,3,1][i-1];
      }
      scoreCell.value = score;
      totalScore += score;
    }
    document.querySelector(`[name="${day}Total"]`).value = totalScore;
  }

  function calculateWeeklyTotalCount() {
    let totalCount = 0;
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const cntInput = document.querySelector(`input[name="${day}Cnt${i}"]`);
        const value = parseInt(cntInput?.value || "0");
        totalCount += isNaN(value) ? 0 : value;
      }
    });
    document.getElementById("weeklyTotalCount").value = totalCount;
  }

  function calculateWeeklyCancelScore() {
    let totalCancel = 0;
    days.forEach(day => {
      const denied = parseInt(document.querySelector(`input[name="${day}Denied"]`)?.value || "0");
      const cancel = parseInt(document.querySelector(`input[name="${day}Cancel"]`)?.value || "0");
      totalCancel += (isNaN(denied) ? 0 : denied);
      totalCancel += (isNaN(cancel) ? 0 : cancel);
    });
    document.getElementById("weeklyCancelScore").value = totalCancel;
  }

  function calculateAchievementRate() {
    const total = parseInt(document.getElementById("weeklyTotalCount")?.value || "0");
    const cancel = parseInt(document.getElementById("weeklyCancelScore")?.value || "0");
    const denominator = total + cancel;
    const achievementField = document.getElementById("weeklyAchievement");

    if (denominator === 0) {
      achievementField.value = "0%";
      return;
    }

    const rate = Math.round((total / denominator) * 100);
    achievementField.value = `${rate}%`;
  }

  function calculateAchievementScore() {
    const achievement = parseFloat(document.getElementById("weeklyAchievement")?.value.replace('%', '') || "0");
    let score = 0;
    if (achievement < 60) score = 0;
    else if (achievement < 85) score = 20;
    else if (achievement < 90) score = 25;
    else if (achievement < 98) score = 30;
    else score = 40;
    document.getElementById("weeklyAchievementScore").value = score;
  }

  function calculateWeeklyTimeSlotScore() {
    let totalScore = 0;
    days.forEach(day => {
      const score = parseInt(document.querySelector(`input[name="${day}Total"]`)?.value || "0");
      totalScore += isNaN(score) ? 0 : score;
    });
    document.getElementById("weeklyTimeSlotScore").value = totalScore;
  }

  function calculateWeeklyTotalScore() {
    const timeSlot = parseInt(document.getElementById("weeklyTimeSlotScore")?.value || "0");
    const achievement = parseInt(document.getElementById("weeklyAchievementScore")?.value || "0");
    const total = (isNaN(timeSlot) ? 0 : timeSlot) + (isNaN(achievement) ? 0 : achievement);
    document.getElementById("weeklyTotalScore").value = total;
  }

  function runAllCalculations() {
    days.forEach(day => calculateDailyScore(day));
    calculateWeeklyTotalCount();
    calculateWeeklyCancelScore();
    calculateAchievementRate();
    calculateAchievementScore();
    calculateWeeklyTimeSlotScore();
    calculateWeeklyTotalScore();
  }

  document.addEventListener('DOMContentLoaded', () => {
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const input = document.querySelector(`input[name="${day}Cnt${i}"]`);
        if (input) input.addEventListener("input", runAllCalculations);
      }
      const denied = document.querySelector(`input[name="${day}Denied"]`);
      const cancel = document.querySelector(`input[name="${day}Cancel"]`);
      if (denied) denied.addEventListener("input", runAllCalculations);
      if (cancel) cancel.addEventListener("input", runAllCalculations);
    });

    if (!isAdmin) {
      document.querySelectorAll('input').forEach(input => {
        input.setAttribute('readonly', true);
      });
    }

    const btn = document.getElementById("calculateButton");
    if (btn) {
      btn.addEventListener("click", () => {
        runAllCalculations();
        const inputs = document.querySelectorAll('input');
        const data = {};
        inputs.forEach(input => {
          const key = input.name || input.id;
          if (key) data[key] = input.value;
        });
        fetch('/save-score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data })
        }).then(res => {
          if (res.ok) alert("✅ 저장 완료!");
          else alert("❌ 저장 실패");
        }).catch(err => {
          console.error("❌ 저장 오류:", err);
          alert("저장 중 오류가 발생했습니다.");
        });
      });
    }

    const savedData = <%- JSON.stringify(allScoreData || {}) %>;
    for (const key in savedData) {
      const el = document.querySelector(`[name="${key}"], [id="${key}"]`);
      if (el) el.value = savedData[key];
    }

    runAllCalculations();
  });
</script>
