<% layout('layout') %>
<div class="top-bar px-3 py-3" style="background-color: #f8f9fa; border-bottom: 5px solid #ddd;">
  <div class="container">
    
    <!-- 1í–‰: ì œëª© + ìµœì¢… ì‹œê°„ -->
    <div class="row">
      <div class="col-6 d-flex align-items-center">
        <h5 class="mb-0">ìˆ˜í–‰ í˜„í™©</h5>
      </div>
      <div class="col-6 text-end text-muted" id="finalRegScoreTime" style="font-size: 0.9rem;">
        <!-- (ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: yyyy-mm-dd hh:mm:ss) -->
      </div>
    </div>

    <!-- 2í–‰: ì§€í‘œ + ì ìˆ˜ + ë²„íŠ¼ -->
    <div class="row mt-2 gy-2 gx-3 align-items-center">
      <!-- ì£¼ê°„ ìˆ˜í–‰ ì§€í‘œ -->
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ì£¼ê°„ ìˆ˜í–‰ëŸ‰</label>
        <input type="text" id="weeklyTotalCount" class="form-control form-control-sm text-end" readonly style="width: 80px; font-size: 15px;">
      </div>
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ê±°ì ˆ ë° ë°°ì°¨ì·¨ì†Œ</label>
        <input type="text" id="weeklyCancelScore" class="form-control form-control-sm text-end" readonly style="width: 80px; font-size: 15px;">
      </div>
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ìˆ˜í–‰ìœ¨</label>
        <input type="text" id="weeklyAchievement" class="form-control form-control-sm text-end" readonly style="width: 80px; font-size: 15px;">
      </div>

      <!-- ìˆ˜í–‰ìœ¨ ì ìˆ˜ -->
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ìˆ˜í–‰ìœ¨ ì ìˆ˜</label>
        <input type="text" id="weeklyAchievementScore" class="form-control form-control-sm text-end" readonly style="width: 80px; font-size: 15px;">
      </div>

      <!-- ì‹œê°„ëŒ€ ì ìˆ˜ -->
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ì‹œê°„ëŒ€ ì´ ì ìˆ˜</label>
        <input type="text" id="weeklyTimeSlotScore" class="form-control form-control-sm text-end" readonly style="width: 80px; font-size: 15px;">
      </div>

      <!-- í•©ì‚° ì ìˆ˜ -->
      <div class="col-6 col-md-auto d-flex align-items-center">
        <label class="form-label mb-0 me-2" style="font-size: 15px;">ì£¼ê°„ í•©ì‚° ì ìˆ˜</label>
        <input type="text" id="weeklyTotalScore" class="form-control text-center" readonly style="width: 100px; background-color: #e5fa85; font-size: 15px;">
      </div>

      <!-- ì €ì¥ ë²„íŠ¼ -->
      <% if (adminList.some(admin => admin.username === currentUser?.username)) { %>
      <div class="col-6 col-md-auto d-flex align-items-center">
        <button id="calculateButton" class="btn btn-primary">ì €ì¥ í•˜ê¸°</button>
      </div>
      <% } %>
    </div>
  </div>
</div>

<div class="main-content">
  <div class="container-fluid">
    <div class="row g-4">
      <% const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];
         const labels = {
           'Wednesday':'ìˆ˜ìš”ì¼','Thursday':'ëª©ìš”ì¼','Friday':'ê¸ˆìš”ì¼','Saturday':'í† ìš”ì¼',
           'Sunday':'ì¼ìš”ì¼','Monday':'ì›”ìš”ì¼','Tuesday':'í™”ìš”ì¼'
         };
         const goals = {
           'Wednesday':[21,20,30,29],
           'Thursday':[21,20,30,29],
           'Friday':[24,21,32,33],
           'Saturday':[31,22,36,31],
           'Sunday':[33,22,35,30],
           'Monday':[21,20,30,29],
           'Tuesday':[21,20,30,29],
         };
      %>
      <% for (let day of days) { %>
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100">
          <div class="card-header text-center fw-bold" style="background-color: #f1f3ff;">
            <%= labels[day] %>
          </div>
          <div class="card-body p-2 table-responsive">
            <table class="table table-bordered align-middle mb-0">
              <thead>
                <tr class="text-center">
                  <th style="width: 25%; background-color: #ced0f4;">ìš´í–‰ ì‹œê°„ëŒ€</th>
                  <th style="width: 15%; background-color: #ced0f4;">ëª©í‘œ</th>
                  <th style="width: 15%; background-color: #ced0f4;">ì‹¤ì œ</th>
                  <th style="width: 15%; background-color: #ced0f4;">ì ìˆ˜</th>
                </tr>
              </thead>
              <tbody>
                <% const times = ['ì˜¤ì „/ì ì‹¬ í”¼í¬','ì˜¤í›„ ë…¼ í”¼í¬','ì €ë… í”¼í¬','ì‹¬ì•¼ ë…¼ í”¼í¬']; %>
                <% for (let i = 0; i < 4; i++) { %>
                  <tr>
                    <td class="text-center"><%= times[i] %></td>
                    <td style="background-color: #ffb9b9;">
                      <input class="form-control text-center" style="background-color: #ffb9b9;" name="<%= day %>tg<%= i+1 %>" value="<%= goals[day][i] %>" readonly>
                    </td>
                    <td style="background-color: #fffaa3;">
                      <input class="form-control text-center" name="<%= day %>Cnt<%= i+1 %>">
                    </td>
                    <td style="background-color: #cec5ff;">
                      <input class="form-control text-center" style="background-color: #cec5ff;" name="<%= day %>Value<%= i+1 %>" readonly>
                    </td>
                  </tr>
                <% } %>
                <tr>
                  <td colspan="2" class="text-center">ê±°ì ˆ</td>
                  <td colspan="2" style="background-color: #ffb8b8;">
                    <input class="form-control" name="<%= day %>Denied">
                  </td>
                </tr>
                <tr>
                  <td colspan="2" class="text-center">ë°°ì°¨ ì·¨ì†Œ</td>
                  <td colspan="2" style="background-color: #d6f1ff;">
                    <input class="form-control" name="<%= day %>Cancel">
                  </td>
                </tr>
                <tr>
                  <td colspan="2" class="text-center fw-bold">ì¼ ì ìˆ˜</td>
                  <td colspan="2">
                    <input class="form-control text-center" style="background-color: #ffadf8;" name="<%= day %>Total">
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>


<script>
  const currentUsername = "<%= currentUser?.username || '' %>";
  const adminUsernames = <%- JSON.stringify(adminList.map(a => a.username)) %>;
  const isAdmin = adminUsernames.includes(currentUsername);
  const savedData = <%- JSON.stringify(allScoreData) %>;  // ëª¨ë“  ìœ ì €ì˜ ì ìˆ˜ ë°ì´í„°
  const savedAt = "<%= updatedAt ? new Date(updatedAt).toLocaleString('ko-KR') : '' %>";
</script>


<script src="/js/score-calculation.js"></script> <!-- ìœ„ JS ì½”ë“œ ë¶„ë¦¬ ì‹œ ì´ ê²½ë¡œ ì‚¬ìš© ê°€ëŠ¥ -->

<script>
  const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];

  function calculateDailyScore(day) {
    let totalScore = 0;
    for (let i = 1; i <= 4; i++) {
      const goal = parseInt(document.querySelector(`[name="${day}tg${i}"]`).value);
      const actual = parseInt(document.querySelector(`[name="${day}Cnt${i}"]`).value);
      const scoreCell = document.querySelector(`[name="${day}Value${i}"]`);
      if (isNaN(actual)) {
        scoreCell.value = "0";
        continue;
      }
      let score = 0;
      if (actual >= goal) {
        if (day === 'Friday') score = [2,2,3,2][i-1];
        else if (day === 'Saturday') score = [3,2,3,2][i-1];
        else if (day === 'Sunday') score = [3,2,3,1][i-1];
        else score = [2,2,3,1][i-1];
      }
      scoreCell.value = score;
      totalScore += score;
    }
    document.querySelector(`[name="${day}Total"]`).value = totalScore;
  }

  function calculateWeeklyTotalCount() {
    let totalCount = 0;
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const cntInput = document.querySelector(`input[name="${day}Cnt${i}"]`);
        const value = parseInt(cntInput?.value || "0");
        totalCount += isNaN(value) ? 0 : value;
      }
    });
    document.getElementById("weeklyTotalCount").value = totalCount;
  }

  function calculateWeeklyCancelScore() {
    let totalCancel = 0;
    days.forEach(day => {
      const denied = parseInt(document.querySelector(`input[name="${day}Denied"]`)?.value || "0");
      const cancel = parseInt(document.querySelector(`input[name="${day}Cancel"]`)?.value || "0");
      totalCancel += (isNaN(denied) ? 0 : denied);
      totalCancel += (isNaN(cancel) ? 0 : cancel);
    });
    document.getElementById("weeklyCancelScore").value = totalCancel;
  }

  function calculateAchievementRate() {
    const total = parseInt(document.getElementById("weeklyTotalCount")?.value || "0");
    const cancel = parseInt(document.getElementById("weeklyCancelScore")?.value || "0");
    const denominator = total + cancel;
    const achievementField = document.getElementById("weeklyAchievement");

    if (denominator === 0) {
      achievementField.value = "0%";
      return;
    }

    const rate = Math.round((total / denominator) * 100);
    achievementField.value = `${rate}%`;
  }

  function calculateAchievementScore() {
    const achievement = parseFloat(document.getElementById("weeklyAchievement")?.value.replace('%', '') || "0");
    let score = 0;
    if (achievement < 60) score = 0;
    else if (achievement < 85) score = 20;
    else if (achievement < 90) score = 25;
    else if (achievement < 98) score = 30;
    else score = 40;
    document.getElementById("weeklyAchievementScore").value = score;
  }

  function calculateWeeklyTimeSlotScore() {
    let totalScore = 0;
    days.forEach(day => {
      const score = parseInt(document.querySelector(`input[name="${day}Total"]`)?.value || "0");
      totalScore += isNaN(score) ? 0 : score;
    });
    document.getElementById("weeklyTimeSlotScore").value = totalScore;
  }

  function calculateWeeklyTotalScore() {
    const timeSlot = parseInt(document.getElementById("weeklyTimeSlotScore")?.value || "0");
    const achievement = parseInt(document.getElementById("weeklyAchievementScore")?.value || "0");
    const total = (isNaN(timeSlot) ? 0 : timeSlot) + (isNaN(achievement) ? 0 : achievement);
    document.getElementById("weeklyTotalScore").value = total;
  }

  function runAllCalculations() {
    days.forEach(day => calculateDailyScore(day));
    calculateWeeklyTotalCount();
    calculateWeeklyCancelScore();
    calculateAchievementRate();
    calculateAchievementScore();
    calculateWeeklyTimeSlotScore();
    calculateWeeklyTotalScore();
  }

  document.addEventListener('DOMContentLoaded', () => {
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const input = document.querySelector(`input[name="${day}Cnt${i}"]`);
        if (input) input.addEventListener("input", runAllCalculations);
      }
      const denied = document.querySelector(`input[name="${day}Denied"]`);
      const cancel = document.querySelector(`input[name="${day}Cancel"]`);
      if (denied) denied.addEventListener("input", runAllCalculations);
      if (cancel) cancel.addEventListener("input", runAllCalculations);
    });

    if (!isAdmin) {
      document.querySelectorAll('input').forEach(input => {
        input.setAttribute('readonly', true);
      });
    }

    const btn = document.getElementById("calculateButton");
   if (btn) {
        btn.addEventListener("click", () => {
            runAllCalculations();
            const inputs = document.querySelectorAll('input');
            const data = {};
            inputs.forEach(input => {
            const key = input.name || input.id;
            if (key) data[key] = input.value;
            });

            // ğŸ“Œ ìµœì¢… ì ìš© ì‹œê°„ ê°±ì‹  (í´ë¼ì´ì–¸íŠ¸ ì‹œê°„ ê¸°ì¤€)
            const now = new Date();
            const formatDate = (d) => {
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            };
            const finalTimeText = `(ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: ${formatDate(now)})`;
            document.getElementById("finalRegScoreTime").innerText = finalTimeText;

            // ì €ì¥ ìš”ì²­
            fetch('/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data })
            }).then(res => {
            if (res.ok) alert("âœ… ì €ì¥ ì™„ë£Œ!");
            else alert("âŒ ì €ì¥ ì‹¤íŒ¨");
            }).catch(err => {
            console.error("âŒ ì €ì¥ ì˜¤ë¥˜:", err);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        });
    }

    const savedData = <%- JSON.stringify(allScoreData || {}) %>;
    for (const key in savedData) {
      const el = document.querySelector(`[name="${key}"], [id="${key}"]`);
      if (el) el.value = savedData[key];
    }

      if (typeof savedAt === 'string' && savedAt) {
        document.getElementById("finalRegScoreTime").innerText = `(ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: ${savedAt})`;
    }

    runAllCalculations();
  });
</script>
