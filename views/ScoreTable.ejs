<% layout('layout') %>
<div class="top-bar px-3 py-4" style="background-color: #f8f9fa; border-bottom: 5px solid #ddd;">
  <div class="container">

    <!-- ì§€í‘œ í–‰ -->
    <div class="row g-3 align-items-center">
      <!-- ì£¼ê°„ ìˆ˜í–‰ ê´€ë ¨ -->
      <div class="col-12 col-md-8 d-flex flex-wrap gap-3 align-items-center justify-content-start">
        <div class="d-flex align-items-center">
          <label class="form-label mt-5 me-2">ì£¼ê°„ ìˆ˜í–‰ëŸ‰</label>
          <input type="text" id="weeklyTotalCount" class="form-control text-end mt-5" readonly style="width: 80px;">
        </div>
        <div class="d-flex align-items-center">
          <label class="form-label mt-5 me-2">ê±°ì ˆ ë° ë°°ì°¨ì·¨ì†Œ</label>
          <input type="text" id="weeklyCancelScore" class="form-control text-end mt-5" readonly style="width: 80px;">
        </div>
        <div class="d-flex align-items-center">
          <label class="form-label mt-5 me-2">ìˆ˜í–‰ìœ¨</label>
          <input type="text" id="weeklyAchievement" class="form-control text-end mt-5" readonly style="width: 80px;">
        </div>
      </div>

      <!-- ì£¼ê°„ ì ìˆ˜ + ì €ì¥ -->
        <div class="col-12 col-md-3 d-flex flex-column align-items-center align-items-md-end mt-2 gap-2">
        <div class="text-center">
            <label class="form-label mb-1">ì£¼ê°„ í•©ì‚° ì ìˆ˜</label><br>
            <input type="text" id="weeklyTotalScore" class="form-control text-center"
                readonly style="width: 100px; background-color: #e5fa85; font-size: 1.4rem;">
        </div>
        <% if (adminList.some(admin => admin.username === currentUser?.username)) { %>
            <button id="calculateButton" class="btn btn-primary">ì €ì¥ í•˜ê¸°</button>
        <% } %>
        </div>
    </div>

    <!-- ì¶”ê°€ ì ìˆ˜ ë° ì‹œê°„ -->
    <div class="row mt-3">
      <div class="col-12 col-md-8 d-flex flex-wrap gap-3 align-items-center">
        <div class="d-flex align-items-center">
          <label class="form-label mb-5 me-2">ìˆ˜í–‰ìœ¨ ì ìˆ˜</label>
          <input type="text" id="weeklyAchievementScore" class="form-control text-end mb-5 " readonly style="width: 80px;">
        </div>
        <div class="d-flex align-items-center">
          <label class="form-label mb-5 me-2">ì‹œê°„ëŒ€ ì´ ì ìˆ˜</label>
          <input type="text" id="weeklyTimeSlotScore" class="form-control text-end mb-5 " readonly style="width: 80px;">
        </div>
      </div>

      <div class="col-12 col-md-4 text-md-end text-center text-muted" id="finalRegScoreTime" style="font-size: 0.9rem;">
        <!-- (ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: yyyy-mm-dd hh:mm:ss) -->
      </div>
    </div>
  </div>
</div>




<div class="main-content">
  <div class="container-fluid">
    <div class="row row-cols-1 row-cols-md-3 g-4">
      <% const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];
         const labels = {
           'Wednesday':'ìˆ˜ìš”ì¼','Thursday':'ëª©ìš”ì¼','Friday':'ê¸ˆìš”ì¼','Saturday':'í† ìš”ì¼',
           'Sunday':'ì¼ìš”ì¼','Monday':'ì›”ìš”ì¼','Tuesday':'í™”ìš”ì¼'
         };
         const goals = {
           'Wednesday':[21,20,30,29],
           'Thursday':[21,20,30,29],
           'Friday':[24,21,32,33],
           'Saturday':[31,22,36,31],
           'Sunday':[33,22,35,30],
           'Monday':[21,20,30,29],
           'Tuesday':[21,20,30,29],
         };
      %>
      <% for (let day of days) { %>
      <div class="col">
        <h4 class="text-center align-middle"><%= labels[day] %></h4>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th class="text-center align-middle" style="width: 20%; background-color: #ced0f4;">ìš´í–‰ ìš”ì¼</th>
                <th class="text-center align-middle" style="width: 30%; background-color: #ced0f4;">ìš´í–‰ ì‹œê°„ëŒ€</th>
                <th class="text-center align-middle" style="width: 15%; background-color: #ced0f4;">ëª©í‘œ<br>ìˆ˜í–‰ëŸ‰</th>
                <th class="text-center align-middle" style="width: 15%; background-color: #ced0f4;">ì‹¤ì œ<br>ìˆ˜í–‰ëŸ‰</th>
                <th class="text-center align-middle" style="width: 15%; background-color: #ced0f4;">ë‹¬ì„±<br>ì ìˆ˜</th>
              </tr>
            </thead>
            <tbody>
              <% const times = ['ì˜¤ì „/ì ì‹¬ í”¼í¬','ì˜¤í›„ ë…¼ í”¼í¬','ì €ë… í”¼í¬','ì‹¬ì•¼ ë…¼ í”¼í¬']; %>
              <% for (let i = 0; i < 4; i++) { %>
                <tr>
                  <% if (i === 0) { %>
                    <td class="text-center align-middle" rowspan="7"><%= labels[day] %></td>
                  <% } %>
                  <td class="text-center align-middle"><%= times[i] %></td>
                  <td class="text-center align-middle" style="background-color: #ffb9b9;"><input class="form-control" style="background-color: #ffb9b9;" name="<%= day %>tg<%= i+1 %>" value="<%= goals[day][i] %>" readonly></td>
                  <td class="text-center align-middle" style="background-color: #fffaa3;"><input class="form-control" name="<%= day %>Cnt<%= i+1 %>"></td>
                  <td class="text-center align-middle" style="background-color: #cec5ff;"><input class="form-control" style="background-color: #cec5ff;" name="<%= day %>Value<%= i+1 %>" readonly></td>
                </tr>
              <% } %>
              <tr>
                <td colspan="2" class="text-center align-middle">ê±°ì ˆ</td>
                <td colspan="2" style="background-color: #ffb8b8;"><input class="form-control" name="<%= day %>Denied"></td>
              </tr>
              <tr>
                <td colspan="2" class="text-center align-middle">ë°°ì°¨ ì·¨ì†Œ</td>
                <td colspan="2" style="background-color: hsl(206, 100%, 87%);"><input class="form-control" name="<%= day %>Cancel"></td>
              </tr>
              <tr>
                <td colspan="2" class="text-center align-middle">ì¼ ì ìˆ˜</td>
                <td colspan="2"><input class="form-control" style="background-color: #ffadf8;"name="<%= day %>Total"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</div>

<script>
  const currentUsername = "<%= currentUser?.username || '' %>";
  const adminUsernames = <%- JSON.stringify(adminList.map(a => a.username)) %>;
  const isAdmin = adminUsernames.includes(currentUsername);
  const savedData = <%- JSON.stringify(allScoreData) %>;  // ëª¨ë“  ìœ ì €ì˜ ì ìˆ˜ ë°ì´í„°
  const savedAt = "<%= updatedAt ? new Date(updatedAt).toLocaleString('ko-KR') : '' %>";
</script>


<script src="/js/score-calculation.js"></script> <!-- ìœ„ JS ì½”ë“œ ë¶„ë¦¬ ì‹œ ì´ ê²½ë¡œ ì‚¬ìš© ê°€ëŠ¥ -->

<script>
  const days = ['Wednesday','Thursday','Friday','Saturday','Sunday','Monday','Tuesday'];

  function calculateDailyScore(day) {
    let totalScore = 0;
    for (let i = 1; i <= 4; i++) {
      const goal = parseInt(document.querySelector(`[name="${day}tg${i}"]`).value);
      const actual = parseInt(document.querySelector(`[name="${day}Cnt${i}"]`).value);
      const scoreCell = document.querySelector(`[name="${day}Value${i}"]`);
      if (isNaN(actual)) {
        scoreCell.value = "0";
        continue;
      }
      let score = 0;
      if (actual >= goal) {
        if (day === 'Friday') score = [2,2,3,2][i-1];
        else if (day === 'Saturday') score = [3,2,3,2][i-1];
        else if (day === 'Sunday') score = [3,2,3,1][i-1];
        else score = [2,2,3,1][i-1];
      }
      scoreCell.value = score;
      totalScore += score;
    }
    document.querySelector(`[name="${day}Total"]`).value = totalScore;
  }

  function calculateWeeklyTotalCount() {
    let totalCount = 0;
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const cntInput = document.querySelector(`input[name="${day}Cnt${i}"]`);
        const value = parseInt(cntInput?.value || "0");
        totalCount += isNaN(value) ? 0 : value;
      }
    });
    document.getElementById("weeklyTotalCount").value = totalCount;
  }

  function calculateWeeklyCancelScore() {
    let totalCancel = 0;
    days.forEach(day => {
      const denied = parseInt(document.querySelector(`input[name="${day}Denied"]`)?.value || "0");
      const cancel = parseInt(document.querySelector(`input[name="${day}Cancel"]`)?.value || "0");
      totalCancel += (isNaN(denied) ? 0 : denied);
      totalCancel += (isNaN(cancel) ? 0 : cancel);
    });
    document.getElementById("weeklyCancelScore").value = totalCancel;
  }

  function calculateAchievementRate() {
    const total = parseInt(document.getElementById("weeklyTotalCount")?.value || "0");
    const cancel = parseInt(document.getElementById("weeklyCancelScore")?.value || "0");
    const denominator = total + cancel;
    const achievementField = document.getElementById("weeklyAchievement");

    if (denominator === 0) {
      achievementField.value = "0%";
      return;
    }

    const rate = Math.round((total / denominator) * 100);
    achievementField.value = `${rate}%`;
  }

  function calculateAchievementScore() {
    const achievement = parseFloat(document.getElementById("weeklyAchievement")?.value.replace('%', '') || "0");
    let score = 0;
    if (achievement < 60) score = 0;
    else if (achievement < 85) score = 20;
    else if (achievement < 90) score = 25;
    else if (achievement < 98) score = 30;
    else score = 40;
    document.getElementById("weeklyAchievementScore").value = score;
  }

  function calculateWeeklyTimeSlotScore() {
    let totalScore = 0;
    days.forEach(day => {
      const score = parseInt(document.querySelector(`input[name="${day}Total"]`)?.value || "0");
      totalScore += isNaN(score) ? 0 : score;
    });
    document.getElementById("weeklyTimeSlotScore").value = totalScore;
  }

  function calculateWeeklyTotalScore() {
    const timeSlot = parseInt(document.getElementById("weeklyTimeSlotScore")?.value || "0");
    const achievement = parseInt(document.getElementById("weeklyAchievementScore")?.value || "0");
    const total = (isNaN(timeSlot) ? 0 : timeSlot) + (isNaN(achievement) ? 0 : achievement);
    document.getElementById("weeklyTotalScore").value = total;
  }

  function runAllCalculations() {
    days.forEach(day => calculateDailyScore(day));
    calculateWeeklyTotalCount();
    calculateWeeklyCancelScore();
    calculateAchievementRate();
    calculateAchievementScore();
    calculateWeeklyTimeSlotScore();
    calculateWeeklyTotalScore();
  }

  document.addEventListener('DOMContentLoaded', () => {
    days.forEach(day => {
      for (let i = 1; i <= 4; i++) {
        const input = document.querySelector(`input[name="${day}Cnt${i}"]`);
        if (input) input.addEventListener("input", runAllCalculations);
      }
      const denied = document.querySelector(`input[name="${day}Denied"]`);
      const cancel = document.querySelector(`input[name="${day}Cancel"]`);
      if (denied) denied.addEventListener("input", runAllCalculations);
      if (cancel) cancel.addEventListener("input", runAllCalculations);
    });

    if (!isAdmin) {
      document.querySelectorAll('input').forEach(input => {
        input.setAttribute('readonly', true);
      });
    }

    const btn = document.getElementById("calculateButton");
   if (btn) {
        btn.addEventListener("click", () => {
            runAllCalculations();
            const inputs = document.querySelectorAll('input');
            const data = {};
            inputs.forEach(input => {
            const key = input.name || input.id;
            if (key) data[key] = input.value;
            });

            // ğŸ“Œ ìµœì¢… ì ìš© ì‹œê°„ ê°±ì‹  (í´ë¼ì´ì–¸íŠ¸ ì‹œê°„ ê¸°ì¤€)
            const now = new Date();
            const formatDate = (d) => {
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            };
            const finalTimeText = `(ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: ${formatDate(now)})`;
            document.getElementById("finalRegScoreTime").innerText = finalTimeText;

            // ì €ì¥ ìš”ì²­
            fetch('/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data })
            }).then(res => {
            if (res.ok) alert("âœ… ì €ì¥ ì™„ë£Œ!");
            else alert("âŒ ì €ì¥ ì‹¤íŒ¨");
            }).catch(err => {
            console.error("âŒ ì €ì¥ ì˜¤ë¥˜:", err);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        });
    }

    const savedData = <%- JSON.stringify(allScoreData || {}) %>;
    for (const key in savedData) {
      const el = document.querySelector(`[name="${key}"], [id="${key}"]`);
      if (el) el.value = savedData[key];
    }

      if (typeof savedAt === 'string' && savedAt) {
        document.getElementById("finalRegScoreTime").innerText = `(ë§ˆì§€ë§‰ ì €ì¥ ì‹œê°„: ${savedAt})`;
    }

    runAllCalculations();
  });
</script>
