<% layout('layout') %>

<% if (latestPromo) { %>
    <h4>ğŸ“¢ ìµœê·¼ í”„ë¡œëª¨ì…˜ ê²°ê³¼ (í”„ë¡œëª¨ì…˜ ê³µì§€ì¼: <%= latestPromo.date %>)</h4>
    <table class="table table-bordered">
      <thead><tr><th>ì´ë¦„</th><th>ì •ì‚° ê¸ˆì•¡</th><th>ë“±ìˆ˜</th><th>ì§€ê¸‰ì•¡</th></tr></thead>
      <tbody>
        <% latestPromo.data.forEach(item => { %>
          <tr>
            <td><%= item.name %></td>
            <td><%= item.value %></td>
            <td><%= item.rank %></td>
            <td><%= item.pay %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  
    <% const matched = latestPromo.data.find(x => x.name === user.name); %>
    <% if (matched) { %>
      <div class="mt-4">
        <h5>ğŸ‰ ë‚˜ì˜ í”„ë¡œëª¨ì…˜ ì§€ê¸‰ ê²°ê³¼</h5>
        <ul>
          <li><strong>ë“±ìˆ˜:</strong> <%= matched.rank %></li>
          <li><strong>ì§€ê¸‰ì•¡:</strong> <%= matched.pay %></li>
        </ul>
      </div>
    <% } else { %>
      <p class="text-muted">âš ï¸ í˜„ì¬ í”„ë¡œëª¨ì…˜ ê²°ê³¼ì— í•´ë‹¹ í•˜ì§€ì•ŠìŠµë‹ˆë‹¤. ã… .ã… </p>
    <% } %>
  <% } else { %>
    <p class="text-muted">ğŸ“­ ì•„ì§ ì €ì¥ëœ í”„ë¡œëª¨ì…˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  <% } %>
  
  <% if (user.username === 'admin' || user.username === 'krogy') { %>
    <h5 class="mt-5">ğŸ—‚ ì´ì „ ë“±ë¡ëœ ì „ì²´ ê²°ê³¼</h5>
    <ul id="promoHistoryList">
      <% allPromos.forEach((p, idx) => { %>
        <li>
          <a href="#" class="promo-history-item" data-index="<%= idx %>">
            <%= new Date(p.createdAt).toLocaleString('ko-KR') %> - <%= p.date %> (<%= p.createdBy %>)
          </a>
        </li>
      <% }) %>
    </ul>
  
    <script>
      const promoHistoryData = <%- JSON.stringify(allPromos || []) %>;
  
      document.querySelectorAll('.promo-history-item').forEach(el => {
        el.addEventListener('click', function (e) {
          e.preventDefault();
          const index = this.getAttribute('data-index');
          const promo = promoHistoryData[index];
          if (!promo || !promo.data) return;
  
          const modalInfo = document.getElementById('modalPromoInfo');
          const modalTable = document.getElementById('modalPromoTableBody');
  
          modalInfo.innerHTML = `
            <strong>ğŸ“… ì‘ì„±ì¼:</strong> ${promo.date}<br>
            <strong>ğŸ‘¤ ì‘ì„±ì:</strong> ${promo.createdBy}<br>
            <strong>ğŸ•’ ë“±ë¡ì¼:</strong> ${new Date(promo.createdAt).toLocaleString('ko-KR')}
          `;
  
          modalTable.innerHTML = '';
          promo.data.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.name}</td>
              <td>${item.value}</td>
              <td>${item.rank}</td>
              <td>${item.pay}</td>
            `;
            modalTable.appendChild(row);
          });
  
          // ëª¨ë‹¬ ì—´ê¸°
          const modal = new bootstrap.Modal(document.getElementById('promoModal'));
          modal.show();
        });
      });
    </script>
    <!-- ğŸ“¦ ëª¨ë‹¬ì°½ (ìˆ¨ê¹€ ìƒíƒœ) -->
<div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="promoModalLabel">ì´ì „ í”„ë¡œëª¨ì…˜ ìƒì„¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
        </div>
        <div class="modal-body">
          <div id="modalPromoInfo" class="mb-3"></div>
          <table class="table table-bordered table-sm text-center">
            <thead>
              <tr>
                <th>ì´ë¦„</th>
                <th>ì •ì‚° ê¸ˆì•¡</th>
                <th>ë“±ìˆ˜</th>
                <th>ì§€ê¸‰ì•¡</th>
              </tr>
            </thead>
            <tbody id="modalPromoTableBody">
              <!-- ë‚´ìš©ì´ JSë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <% } %>