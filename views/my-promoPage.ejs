<% layout('layout') %>

<div class="container mt-5">
  <h2 class="mb-4 text-center">í”„ë¡œëª¨ì…˜ ê²°ê³¼</h2>

  <% if (latestPromo) { %>
    <h4 class="text-center">ğŸ“² ìµœê·¼ í”„ë¡œëª¨ì…˜ ê²°ê³¼ (ê³µì§€ì¼: <%= latestPromo.date %>)</h4>
    <h4 class="text-center" style="color: brown;">âš ï¸ì„¸íŠ¸ ë¯¸ë‹¤ì„±ì‹œ ì ìš©ë˜ì§€ ì•ŠìŒâš ï¸</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-sm text-center align-middle">
        <thead class="table-light">
          <tr><th>ì´ë¦„</th><th>ìˆ˜í–‰ ê±´ìˆ˜</th><th>ë“±ìˆ˜</th><th>ì§€ê¸ˆì•¡</th></tr>
        </thead>
        <tbody>
          <% latestPromo.data.forEach(item => { %>
            <tr>
              <td><%= item.name %></td>
              <td><%= item.value %></td>
              <td><%= item.rank %></td>
              <td><%= item.pay %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <% const matched = latestPromo.data.find(x => x.name === user.name); %>
    <% if (matched) { %>
      <button id="openMyPromoModal" class="d-none" data-bs-toggle="modal" data-bs-target="#myPromoModal">ëª¨ë‹¬ì—´ê¸°</button>

      <div class="modal fade" id="myPromoModal" tabindex="-1" aria-labelledby="myPromoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-info-subtle">
              <h5 class="modal-title" id="myPromoModalLabel">ğŸ‰ ë‚˜ì˜ í”„ë¡œëª¨ì…˜ ì§€ê¸ˆ ê²°ê³¼</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body text-center">
              <p><strong>ë“±ìˆ˜:</strong> <%= matched.rank %></p>
              <p><strong>ì§€ê¸ˆì•¡:</strong> <%= matched.pay %></p>
              <p class="text-danger small">â€» ì„¸íŠ¸ ë¯¸ë‹¤ì„±ì‹œ ì ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      </div>
    <% } else { %>
      <p class="text-muted text-center">âš ï¸ í˜„ì¬ í”„ë¡œëª¨ì…˜ ê²°ê³¼ì— í•´ë‹¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íˆ.íˆ.</p>
    <% } %>
  <% } else { %>
    <p class="text-muted text-center">ğŸ“­ ì•„ì§ ì €ì¥ëœ í”„ë¡œëª¨ì…˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  <% } %>

  <% if (user.username === 'admin' || user.username === 'krogy') { %>
    <h5 class="mt-5">ğŸ“‚ ì´ì „ ë“±ë¡ëœ ì „ì²´ ê²°ê³¼</h5>
    <ul id="promoHistoryList" class="list-group mb-4">
      <% allPromos.forEach((p, idx) => { %>
        <li class="list-group-item">
          <a href="#" class="promo-history-item" data-index="<%= idx %>">
            <span id="nowKSTTime"></span>(<%= p.createdBy %>)
          </a>
        </li>
      <% }) %>
    </ul>

    <div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promoModalLabel">ì´ì „ í”„ë¡œëª¨ì…˜ ìƒì„¸</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body">
            <div id="modalPromoInfo" class="mb-3"></div>
            <div class="table-responsive">
              <table class="table table-bordered table-sm text-center">
                <thead class="table-light">
                  <tr><th>ì´ë¦„</th><th>ì •ì‚° ê¸ˆì•¡</th><th>ë“±ìˆ˜</th><th>ì§€ê¸ˆì•¡</th></tr>
                </thead>
                <tbody id="modalPromoTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <% if (user.username === 'admin' || user.username === 'krogy') { %>
              <button type="button" class="btn btn-danger" id="deletePromoBtn">ì‚­ì œ</button>
            <% } %>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>
  <% } %>
</div>

<script>
  const promoHistoryData = <%- JSON.stringify(allPromos || []) %>;
  let selectedPromoId = null;

  document.querySelectorAll('.promo-history-item').forEach(el => {
    el.addEventListener('click', function (e) {
      e.preventDefault();
      const index = this.getAttribute('data-index');
      const promo = promoHistoryData[index];
      if (!promo || !promo.data) return;

      selectedPromoId = promo._id;

      const modalInfo = document.getElementById('modalPromoInfo');
      const modalTable = document.getElementById('modalPromoTableBody');

      modalInfo.innerHTML = `
        <strong>ğŸ“… ì‘ì„±ì¼:</strong> ${promo.date}<br>
        <strong>ğŸ‘¤ ì‘ì„±ì:</strong> ${promo.createdBy}<br>
        <strong>ğŸ•’ ë“±ë¡ì¼:</strong> ${new Date(promo.createdAt).toLocaleString('ko-KR')}
      `;

      modalTable.innerHTML = '';
      promo.data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.value}</td>
          <td>${item.rank}</td>
          <td>${item.pay}</td>
        `;
        modalTable.appendChild(row);
      });

      const modal = new bootstrap.Modal(document.getElementById('promoModal'));
      modal.show();
    });
  });

  document.getElementById('deletePromoBtn')?.addEventListener('click', () => {
    if (!selectedPromoId) return;
    if (!confirm('ì •ë§ ì´ í”„ë¡œëª¨ì…˜ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch(`/promo-result/${selectedPromoId}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        alert(data.message || 'ì‚­ì œ ì™„ë£Œ');
        location.reload();
      })
      .catch(err => {
        console.error('âŒ ì‚­ì œ ì˜¤ë¥˜:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      });
  });

  window.addEventListener('DOMContentLoaded', () => {
    const myPromoBtn = document.getElementById('openMyPromoModal');
    if (myPromoBtn) {
      myPromoBtn.click();
    }
  });

  const now = new Date();
  const nowKST = new Date(now.getTime() + 9 * 60 * 60 * 1000);
  const yyyy = nowKST.getFullYear();
  const mm = String(nowKST.getMonth() + 1).padStart(2, '0');
  const dd = String(nowKST.getDate()).padStart(2, '0');
  const hh = String(nowKST.getHours()).padStart(2, '0');
  const min = String(nowKST.getMinutes()).padStart(2, '0');
  const ss = String(nowKST.getSeconds()).padStart(2, '0');
  const formatted = `${yyyy}-${mm}-${dd} ${hh}:${min}:${ss}`;
  document.getElementById('nowKSTTime').innerText = formatted;
</script>
