<% layout('layout') %>

<div class="container mt-5">

  <!-- ë¡œê³  -->
  <div class="mb-4 text-center">
    <img src="/images/logo.png" alt="ë¡œê³ " class="img-fluid" style="max-height: 40px;">
  </div>

  <!-- ì¸ì‚¬ë§ -->
  <div class="text-center mb-4">
    <% if (user.username === 'krogy' || user.username === 'admin') { %>
      <h2 class="fw-bold">ì§€ì‚¬ì¥ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤!</h2>
    <% } else { %>
      <h2 class="fw-bold">í™˜ì˜í•©ë‹ˆë‹¤, <%= user.name %>ë‹˜!</h2>
      <p class="text-muted">ê°€ì… ì§€ì‚¬: <%= user.branch %></p>
    <% } %>
  </div>

  <!-- ì§„í–‰ì¤‘ì¸ ì´ë²¤íŠ¸ ì¹´ë“œ -->
  <% if (activeEvent) { %>
    <div class="mx-auto mb-5" style="max-width: 600px; position: relative;">
      <!-- ìˆ˜ë ¹ ì™„ë£Œ ì•Œë¦¼ì°½ -->
      <div id="claimSuccessAlert" class="alert alert-success alert-dismissible fade d-none" role="alert"
           style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px;">
        ğŸ‰ ìˆ˜ë ¹ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <!-- ì§ì›ìš© ì•ˆë‚´ì°½ -->
      <div id="staffAlert" class="alert alert-info alert-dismissible fade d-none" role="alert"
           style="position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 400px;">
        ë§¤ì¥ ì§ì›ì— ë³´ì—¬ì£¼ì„¸ìš”.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div class="card shadow border-start border-primary border-4 rounded-3">
        <div class="card-body text-center">
          <h5 class="card-title fw-bold text-primary">ì§„í–‰ì¤‘ì¸ ì´ë²¤íŠ¸</h5>
          <p><strong><%= activeEvent.title %></strong></p>
          <p><strong><%= activeEvent.item %></strong></p>
          <p><strong>ë‚¨ì€ ìˆ˜ëŸ‰:</strong> <span id="remainingCount"><%= activeEvent.quantity %></span>ê°œ</p>

          <!-- ë²„íŠ¼ & ë©”ì‹œì§€ ì˜ì—­ -->
          <div id="actionSection">
            <% if (activeEvent.quantity <= 0) { %>
              <p id="endMessage" class="mt-2 text-danger fw-bold">ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <% } else { %>
              <button id="showCodeBtn" class="btn btn-outline-success btn-sm mt-2" onclick="showCodeInput()" style="width: 50%;">ì´ë²¤íŠ¸ ìˆ˜ë ¹</button>
              <div id="codeSection" class="mt-3" style="display: none;">
                <input type="text"
                       id="codeInput"
                       placeholder="í™•ì¸ ì½”ë“œ ì…ë ¥"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       style="width: 50%; margin: 0 auto; display: block; padding: 0.375rem 0.75rem; border: 1px solid #ced4da; border-radius: 0.25rem;">
                <button id="submitCodeBtn" class="btn btn-primary btn-sm" onclick="submitCode()" style="width: 50%; margin: 0.5rem auto 0; display: block;">ìˆ˜ë ¹ í™•ì¸</button>
                <div id="codeMessage" class="mt-2 fw-bold text-center"></div>
              </div>
            <% } %>
          </div>

        </div>
      </div>
    </div>
  <% } %>

  <!-- íŒŒì¼ ì—…ë¡œë“œ -->
  <% if (user.username === 'krogy' || user.username === 'admin') { %>
    <div class="mx-auto mb-5" style="max-width: 600px;">
      <div class="card shadow rounded-3">
        <div class="card-body">
          <h5 class="card-title text-center mb-3">ì´ë¯¸ì§€ ì—…ë¡œë“œ</h5>
          <form id="uploadForm" action="/upload-welcome-image" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
              <input type="file" id="fileInput" name="welcomeImage" class="form-control" accept="image/*" required>
            </div>
            <button type="submit" class="btn btn-success w-100">íŒŒì¼ ì—…ë¡œë“œ</button>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <!-- ì—…ë¡œë“œëœ ì´ë¯¸ì§€ í‘œì‹œ -->
  <% if (uploadedImagePath) { %>
    <div class="mx-auto mb-5" style="max-width: 600px;">
      <div class="card shadow rounded-3">
        <div class="card-body text-center">
          <h5 class="card-title">ê³µì§€ ì‚¬í•­</h5>
          <img src="<%= uploadedImagePath %>" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€" class="img-fluid mt-3 rounded">
        </div>
      </div>
    </div>
  <% } %>

</div>

<script>
  function showCodeInput() {
    document.getElementById('codeSection').style.display = 'block';
    document.getElementById('codeMessage').innerText = '';

    // ì§ì› ì•ˆë‚´ì°½
    const staffBox = document.getElementById('staffAlert');
    staffBox.classList.remove('d-none');
    staffBox.classList.add('show');
    setTimeout(() => { bootstrap.Alert.getOrCreateInstance(staffBox).close(); }, 5000);
  }

  function submitCode() {
    const code = document.getElementById('codeInput').value.trim();
    const messageEl = document.getElementById('codeMessage');
    const alertBox = document.getElementById('claimSuccessAlert');
    const codeSection = document.getElementById('codeSection');
    const remainingEl = document.getElementById('remainingCount');
    const showBtn = document.getElementById('showCodeBtn');
    const endMessage = document.getElementById('endMessage');

    if (code !== '51421262') {
      messageEl.innerText = 'âŒ í™•ì¸ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      messageEl.className = 'text-danger fw-bold';
      return;
    }

    fetch('/claim-event', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: '<%= user.username %>', date: new Date().toISOString() })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // ìˆ˜ëŸ‰ ê°±ì‹ 
        remainingEl.innerText = data.newQuantity;
        // ì…ë ¥ ì„¹ì…˜ ìˆ¨ê¹€
        codeSection.style.display = 'none';
        document.getElementById('codeInput').value = '';

        // ìˆ˜ë ¹ ì™„ë£Œ ì•Œë¦¼
        alertBox.classList.remove('d-none');
        alertBox.classList.add('show');
        setTimeout(() => { bootstrap.Alert.getOrCreateInstance(alertBox).close(); }, 5000);

        // ìˆ˜ëŸ‰ 0 ì‹œ ë²„íŠ¼ ìˆ¨ê¸°ê³  ë©”ì‹œì§€ í‘œì‹œ
        if (data.newQuantity <= 0) {
          showBtn.style.display = 'none';
          if (endMessage) {
            endMessage.style.display = 'block';
          } else {
            // ë™ì  ìƒì„±
            const msg = document.createElement('p');
            msg.className = 'mt-2 text-danger fw-bold';
            msg.innerText = 'ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('actionSection').appendChild(msg);
          }
        }
      } else {
        messageEl.innerText = data.message || 'ì²˜ë¦¬ ì‹¤íŒ¨';
        messageEl.className = 'text-danger fw-bold';
      }
    })
    .catch(err => {
      console.error('ìš”ì²­ ì‹¤íŒ¨:', err);
      messageEl.innerText = 'ì„œë²„ ì˜¤ë¥˜';
      messageEl.className = 'text-danger fw-bold';
    });
  }
</script>
