<% layout('layout') %>

<div class="container mt-5">
  <h2 class="mb-4">등록된 유저 목록</h2>

  <!-- 검색 및 필터 영역 -->
  <div class="row mb-4">
    <div class="col-12 col-md-4 mb-2">
      <select id="branchFilter" class="form-select">
        <option value="">가입 지사 선택 (전체)</option>
        <% const branches = [...new Set(users.map(u => u.branch))]; branches.forEach(branch => { %>
          <option value="<%= branch %>"><%= branch %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-12 col-md-4 mb-2">
      <input type="text" id="searchInput" class="form-control" placeholder="아이디 또는 이름 검색">
    </div>
    <div class="col-12 col-md-4 mb-2">
      <button class="btn btn-primary w-100" onclick="resetFilters()">필터 초기화</button>
    </div>
  </div>

  <% if (users.length > 0) { %>
    <!-- 데스크탑: 테이블 -->
    <div class="table-responsive d-none d-md-block">
      <table class="table table-striped align-middle text-center" id="userTable">
        <thead class="table-light">
          <tr>
            <th>아이디</th>
            <th>이름</th>
            <th>배민커넥트 아이디</th>
            <th>전화번호</th>
            <th>가입 지사</th>
            <th>가입일</th>
            <th colspan="2">관리</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(user => { %>
            <tr>
              <td><%= user.username %></td>
              <td><%= user.name %></td>
              <td><%= user.connectId %></td>
              <td><%= user.phone %></td>
              <td><%= user.branch %></td>
              <td><%= new Date(user.createdAt).toLocaleDateString('ko-KR') %></td>
              <td>
                <div class="d-flex flex-column gap-1">
                  <a href="/edit-user/<%= user._id %>" class="btn btn-sm btn-warning">수정</a>
                  
                </div>
              </td>
              <td>
                <div class="d-flex flex-column gap-1">
                  <form action="/delete-user/<%= user._id %>" method="POST" onsubmit="return confirm('정말 삭제하시겠습니까?')">
                    <button type="submit" class="btn btn-sm btn-danger">삭제</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- 모바일: 카드 -->
    <div class="d-block d-md-none" id="mobileCardList">
      <% users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(user => { %>
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title"><%= user.name %> (<%= user.username %>)</h5>
            <p class="mb-1"><strong>배민커넥트 ID:</strong> <%= user.connectId %></p>
            <p class="mb-1"><strong>전화번호:</strong> <%= user.phone %></p>
            <p class="mb-1"><strong>지사:</strong> <%= user.branch %></p>
            <p class="mb-2"><strong>가입일:</strong> <%= new Date(user.createdAt).toLocaleDateString('ko-KR') %></p>
            <div class="d-flex gap-2">
              <a href="/edit-user/<%= user._id %>" class="btn btn-sm btn-warning w-50">수정</a>
              <form action="/delete-user/<%= user._id %>" method="POST" onsubmit="return confirm('정말 삭제하시겠습니까?')" class="w-50">
                <button type="submit" class="btn btn-sm btn-danger w-100">삭제</button>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p>등록된 유저가 없습니다.</p>
  <% } %>

  <div class="mt-4">
    <a href="/" class="btn btn-secondary">홈으로</a>
  </div>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const branchFilter = document.getElementById('branchFilter');

  searchInput.addEventListener('input', filterTable);
  branchFilter.addEventListener('change', filterTable);

  function filterTable() {
    const searchText = searchInput.value.toLowerCase();
    const selectedBranch = branchFilter.value;

    const filterRow = (row, getData) => {
      const { username, name, branch } = getData(row);
      const matchesSearch = username.includes(searchText) || name.includes(searchText);
      const matchesBranch = !selectedBranch || branch === selectedBranch;
      row.style.display = (matchesSearch && matchesBranch) ? '' : 'none';
    };

    document.querySelectorAll('#userTableBody tr').forEach(row => {
      filterRow(row, row => ({
        username: row.children[0].textContent.toLowerCase(),
        name: row.children[1].textContent.toLowerCase(),
        branch: row.children[4].textContent
      }));
    });

    document.querySelectorAll('#mobileCardList .card').forEach(card => {
      filterRow(card, card => ({
        username: card.querySelector('.card-title').textContent.split('(')[1].split(')')[0].toLowerCase(),
        name: card.querySelector('.card-title').textContent.split('(')[0].trim().toLowerCase(),
        branch: card.querySelector('p:nth-of-type(3)').textContent.replace('지사:', '').trim()
      }));
    });
  }

  function resetFilters() {
    searchInput.value = '';
    branchFilter.value = '';
    filterTable();
  }
</script>
