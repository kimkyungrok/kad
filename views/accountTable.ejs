<% layout('layout') %>

<!-- ì‘ì„±ì¼ ì…ë ¥ -->
<div class="container my-4">
  <form id="checkForm" class="row g-2 align-items-center">
    <div class="col-auto">
      <label for="writtenDate" class="form-label">ì‘ì„±ì¼:</label>
    </div>
    <div class="col-auto">
      <input type="date" id="writtenDate" class="form-control" required>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">í™•ì¸</button>
    </div>
  </form>
</div>

<!-- ì •ì‚° í…Œì´ë¸” -->
<table class="table table-bordered">
  <thead>
    <tr>
      <th>ì´ë¦„</th>
      <th>ì •ì‚° ê¸ˆì•¡</th>
      <th>ë“±ìˆ˜</th>
      <th>ì§€ê¸‰ì•¡</th>
    </tr>
  </thead>
  <tbody id="riderTableBody">
    <% riderData.forEach((item, index) => { %>
    <tr data-rank="<%= item.rank %>" data-name="<%= item.name %>">
        <td><%= item.name %></td>
        <td><%= item.value.toLocaleString() %></td>
        <td><%= item.rank || '-' %></td>
        <td class="payCell"></td> <!-- ì´ ì¹¸ì— ì§€ê¸‰ì•¡ ìë™ ì…ë ¥ -->
      </tr>
    <% }) %>
  </tbody>
</table>

<!-- ì§€ê¸‰ì•¡ ìë™ ì…ë ¥ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    const promos = <%- JSON.stringify(promos || []) %>;
  
    document.getElementById('checkForm').addEventListener('submit', function (e) {
      e.preventDefault();
  
      const inputDate = document.getElementById('writtenDate').value;
      if (!inputDate) return alert("ì‘ì„±ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  
      console.log('ğŸŸ¡ ì‚¬ìš©ì ì…ë ¥ ë‚ ì§œ:', inputDate);
      console.log('ğŸŸ¡ promos ë°°ì—´:', promos);
  
      let matchedPromo = null;
  
      promos.forEach((promo, index) => {
        const promoDate = new Date(promo.createdAt).toISOString().slice(0, 10);
        const type = promo.type;
  
        console.log(`ğŸ“„ [${index}] promoDate = ${promoDate}, type = ${type}`);
        if (promoDate === inputDate && type === 'table') {
          matchedPromo = promo;
        }
      });
  
      if (!matchedPromo) {
        alert("í•´ë‹¹ ì‘ì„±ì¼ì˜ í‘œ í˜•ì‹ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
  
      alert(`âœ… í”„ë¡œëª¨ì…˜ ë§¤ì¹­ë¨:\nì‘ì„±ì¼: ${new Date(matchedPromo.createdAt).toISOString().slice(0, 10)}\níƒ€ì…: ${matchedPromo.type}`);
  
      const promoTable = matchedPromo.content;
      const rows = document.querySelectorAll('#riderTableBody tr');
  
      console.log('ğŸ“‹ í”„ë¡œëª¨ì…˜ í‘œ ë°ì´í„°:', promoTable);
  
      rows.forEach((row, i) => {
        const rank = parseInt(row.getAttribute('data-rank'));
        const rankLabel = `${rank}ë“±`; // ì˜ˆ: "1ë“±"
        let amount = '';
  
        console.log(`ğŸ” Row ${i} ë“±ìˆ˜: ${rankLabel}`);
  
        if (rank >= 1 && rank <= 5) {
          Object.values(promoTable).forEach((rowObj, idx) => {
            const values = Object.values(rowObj);
            const label = values[0]?.toString().trim();  // ë“±ìˆ˜ í…ìŠ¤íŠ¸
            const value = values[1];
  
            console.log(`  ğŸ” ë¹„êµ ${idx}: label=${label}, value=${value}`);
            if (label === rankLabel) {
              amount = value;
              console.log(`  âœ… ë§¤ì¹­ë¨: ${rankLabel} = ${value}`);
            }
          });
  
          const cell = row.querySelector('.payCell');
          if (amount && cell) {
            cell.innerText = amount;
            console.log(`ğŸ’° ì§€ê¸‰ì•¡ ì…ë ¥ ì™„ë£Œ: ${amount}`);
          } else {
            console.warn(`âš ï¸ ì§€ê¸‰ì•¡ ì—†ìŒ ë˜ëŠ” ì…€ ì˜¤ë¥˜: Row ${i}, amount=${amount}, cell=`, cell);
          }
        }
      });
    });
  </script>
  